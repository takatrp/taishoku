<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>退職金試算ツール</title>
  <meta name="description" content="役員および従業員の退職金適正額や手取り額を試算するツールです。">

  <!-- ファビコン設定 -->
  <link rel="icon" href="favicon192192.png" sizes="192x192" />
  <link rel="shortcut icon" href="favicon192192.png" />
  <link rel="apple-touch-icon" href="favicon192192.png" />
  <meta name="theme-color" content="#578899" />

  <style>
    :root{
      --bg:#f4f9fb;
      --card:#ffffff;
      --ink:#1e2a2d;
      --muted:#5a6a6d;
      --accent:#578899;
      --accent-dark:#476a7c;
      --accent-soft:rgba(87,136,153,.08);
      --accent-pale:rgba(87,136,153,0.1);
      --border:#d4e1e7;
      --danger:#b42318;
      --success-text: #009e7f; 
      --shadow:0 18px 40px rgba(20,50,70,.12);
      --radius-lg:18px;
      --radius-pill:999px;
      
      --btn-soft-bg: #f0f8fa;
      --btn-soft-border: #dbe9ee;
      --btn-soft-text: #4a7d8f;
      --btn-outline-border: #4a7d8f;
    }
    
    /* 基本リセット */
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-size: 15px;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height: 1.6;
      -webkit-text-size-adjust: 100%;
    }

    /* 印刷専用要素（画面では非表示） */
    .print-header-fixed, .print-footer-fixed {
      display: none;
    }

    /* アプリケーション構造 */
    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    
    /* 画面用ヘッダー */
    .app-header{
      background:rgba(244, 249, 251, 0.95);
      padding: 12px 0 8px;
      border-bottom:1px solid #d4e1e7;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
    }
    .header-bar{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 16px;
    }
    .brand{
      display:inline-flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--ink);
    }
    .brand-logo{
      height:44px;
      width:auto;
      border-radius:12px;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title{
      font-size:22px;
      margin:0;
      font-weight:700;
    }
    .brand-subtitle{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    /* メインレイアウト */
    .layout{
      width:100%;
      max-width:1080px;
      margin:0 auto;
      padding:16px;
      flex:1 0 auto;
    }

    /* カードコンポーネント */
    .card{
      background:var(--card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:24px;
      margin-bottom:20px;
      border:1px solid rgba(255,255,255,.8);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:16px;
      flex-wrap: wrap;
    }
    .card-title{
      margin:0;
      font-size:18px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:10px;
      border-left: 4px solid var(--accent);
      padding-left: 10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.8);
      font-size:11px;
      background:rgba(0,0,0,.05);
      color: var(--muted);
    }

    /* フォーム要素 */
    .grid{ display:grid; gap:16px 20px; }
    .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    @media(max-width:768px){
      .grid-2, .grid-3{ grid-template-columns:1fr; }
    }

    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:14px; font-weight:700; color:var(--ink); }
    .field small, .field .suffix { font-size:12px; color:var(--muted); line-height: 1.5; }

    input[type="number"], input[type="text"], select{
      border-radius:10px;
      border:1px solid var(--border);
      padding:12px;
      font-size:16px;
      width:100%;
      background:#f9fcff;
      text-align: right;
      outline:none;
      color: var(--ink);
    }
    select {
      text-align: left;
      /* アイコンはデフォルトまたは別途指定 */
    }
    input:focus, select:focus{
      border-color:var(--accent);
      background:#fff;
      box-shadow:0 0 0 3px var(--accent-soft);
    }
    input.align-left{ text-align:left; }
    
    /* チェックボックスUI */
    .checkbox-chip {
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:var(--ink);
      cursor:pointer;
      padding:8px 0;
    }
    .checkbox-chip input {
      transform: scale(1.3);
      cursor: pointer;
    }

    /* ラジオボタン風UI */
    .radio-row{ display:flex; flex-wrap:wrap; gap:10px; }
    .radio-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:10px 16px;
      border-radius:var(--radius-pill);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      border:1px solid transparent;
      transition:all .2s;
    }
    .radio-chip input{ display:none; }
    .radio-chip span::before{
      content:""; width:16px; height:16px;
      border-radius:50%; border:2px solid #ccc;
      display:inline-block; margin-right:6px; vertical-align:-3px;
    }
    .radio-chip input:checked + span{ color:var(--accent); }
    .radio-chip input:checked + span::before{
      border-color:var(--accent);
      background:radial-gradient(circle, var(--accent) 40%, #fff 45%);
    }

    /* 独自：ヘルパーボタン (チップ) */
    .chips-container {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .helper-btn {
      font-size: 11px;
      padding: 4px 10px;
      border: 1px solid var(--accent);
      background: #fff;
      color: var(--accent);
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-weight: 600;
    }
    .helper-btn:hover { background: var(--accent-soft); }
    .helper-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 4px rgba(87,136,153,.3);
    }

    /* ボタン */
    .btn-row{ display:flex; gap:12px; margin-top:20px; flex-wrap:wrap; }
    .btn-calc{
      border:none; border-radius:var(--radius-pill);
      padding:12px 28px; font-weight:700;
      background:var(--accent); color:#fff;
      cursor:pointer; display:flex; align-items:center; gap:8px;
      box-shadow:0 4px 12px rgba(87,136,153,.3);
    }
    .btn-ghost{
      background:transparent; border:1px dashed var(--border);
      color:var(--muted); padding:10px 20px; border-radius:var(--radius-pill);
      cursor:pointer; font-size:13px;
    }
    
    /* 結果表示エリア */
    .result-card{ border-left:4px solid var(--accent); background:#fff; }
    .result-grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); }
    .metric{
      padding:16px; border-radius:12px; background:var(--accent-soft);
      border:1px solid rgba(87,136,153,.1);
    }
    .metric-featured{ background:#fff; border:2px solid var(--accent); box-shadow:0 4px 12px rgba(87,136,153,.15); }
    .metric-label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
    .metric-value{ font-size:22px; font-weight:700; color:var(--ink); }
    .metric-sub{ font-size:11px; color:var(--muted); margin-top:4px; }

    /* 強調表示 */
    .highlight-val { color: var(--success-text); font-weight: 800; }
    .warn-text { color: var(--danger); font-weight: bold; font-size: 0.9rem; margin-top: 8px; }
    .error { color: var(--danger); font-weight: bold; font-size: 0.9rem; margin-top: 12px; }

    /* テーブル */
    .detail-table{
      width:100%; border-collapse:collapse; font-size:13px; margin-top:16px;
      white-space:nowrap;
    }
    .detail-table th, .detail-table td{
      border:1px solid var(--border); padding:10px; text-align:right;
    }
    .detail-table th{ background:#f7fafb; text-align:left; color:var(--muted); }
    
    /* 計算詳細 */
    details.calc-process {
      margin-top: 12px;
      background: #fdfdfd;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
    }
    details.calc-process summary {
      padding: 10px 12px;
      cursor: pointer;
      color: var(--accent-dark);
      font-weight: 600;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    details.calc-process summary::before {
      content: "▶"; font-size: 0.7em; transition: transform 0.2s;
    }
    details.calc-process[open] summary::before { transform: rotate(90deg); }
    .process-content {
      padding: 12px;
      color: var(--muted);
      border-top: 1px dashed var(--border);
    }
    .process-formula {
      font-family: monospace;
      background: rgba(0,0,0,0.02);
      padding: 4px;
      border-radius: 4px;
      display: block;
      margin-top: 4px;
    }

    /* ピル */
    .pill{
      display:inline-flex; align-items:center; border-radius:4px;
      font-size:.7rem; padding:2px 6px; margin-left:6px; vertical-align:middle;
    }
    .pill-danger{ background:rgba(192,57,43,.1); color:var(--danger); }
    .pill-ok{ background:rgba(31,157,85,.1); color:var(--success-text); }

    /* 下部アクション */
    .action-buttons{ display:flex; gap:12px; flex-wrap:wrap; margin-top:0; }
    .btn-soft, .btn-outline{
      flex:1; padding:12px; border-radius:8px; font-weight:700; cursor:pointer; text-align:center;
    }
    .btn-soft{ background:var(--btn-soft-bg); color:var(--btn-soft-text); border:1px solid var(--btn-soft-border); }
    .btn-outline{ background:#fff; color:var(--btn-outline-border); border:2px solid var(--btn-outline-border); }

    .hidden{ display:none!important; }
    
    /* ノート */
    .note-card li{ font-size:13px; color:var(--muted); margin-bottom:6px; }
    .note-highlight{
      border-radius:10px; padding:12px; background:#fffbe8;
      border:1px solid #f5e2a0; font-size:13px; color:#6a4c0a;
      margin-top:12px; line-height: 1.6;
    }

    footer.mk-mini {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      padding: 20px;
    }
    footer.mk-mini a{ color:inherit; }

    /* =========================================
       印刷設定 (Print CSS) 
       ========================================= */
    @media print {
      @page {
        size: A4;
        margin-top: 10mm; 
        margin-bottom: 25mm;
        margin-left: 15mm;
        margin-right: 15mm;
      }

      body {
        background: #fff !important;
        color: #000 !important;
        font-size: 10.5pt;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding-bottom: 20mm;
      }

      .app {
        display: block !important;
        height: auto !important;
        overflow: visible !important;
        padding-top: 0;
      }

      .app-header, .btn-row, .helper-btn, .btn-ghost, 
      .action-buttons, #bottomActions, footer.mk-mini {
        display: none !important;
      }

      /* 固定ヘッダー */
      .print-header-fixed {
        display: none !important;
      }

      /* 固定フッター（画像表示用） */
      .print-footer-fixed {
        display: flex !important;
        position: fixed;
        bottom: 0; 
        left: 0;
        width: 100%;
        height: 20mm;
        align-items: flex-end;
        justify-content: center;
        background-color: transparent; 
        z-index: 9999;
        padding-bottom: 5mm;
      }
      .print-footer-img {
        max-height: 15mm;
        max-width: 100%;
        object-fit: contain;
      }

      .print-logo-section { display: flex; align-items: center; gap: 15px; }
      .print-logo { height: 35px; width: auto; object-fit: contain; }
      .print-company-name { font-size: 14pt; font-weight: 700; color: var(--ink); }
      .print-report-title { font-size: 10pt; color: var(--muted); }

      .layout {
        display: block !important;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      .card {
        box-shadow: none;
        border: none;
        border-bottom: 1px solid #eee;
        padding: 5px 0;
        margin-bottom: 15px;
        break-inside: avoid;
        page-break-inside: avoid;
        background: transparent;
      }
      .card-header { margin-bottom: 5px; border-bottom: none; }
      .card-title {
        font-size: 12pt;
        color: #000;
        border-left: 4px solid var(--accent);
        padding-left: 10px;
      }
      
      .field {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px dotted #ccc;
        padding: 4px 0;
        page-break-inside: avoid;
      }
      .field label { color: #444; font-weight: normal; font-size: 10pt; }
      .field small, .field .suffix { display: none !important; }
      
      input[type="number"], input[type="text"], select {
        border: none; background: transparent; text-align: right;
        font-weight: bold; color: #000; width: auto; padding: 0;
        font-size: 11pt; -webkit-appearance: none; appearance: none;
      }
      
      .radio-row { gap: 15px; justify-content: flex-end; }
      .radio-chip { padding: 0; border: none; }
      .radio-chip input:not(:checked) + span { display: none; }
      .radio-chip input:checked + span {
        color: #000; font-weight: bold; font-size: 11pt;
      }
      .radio-chip span::before { display: none; }
      .checkbox-chip { padding:0; }

      .result-card {
        background: #fdfdfd !important;
        border: 2px solid var(--accent) !important;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        break-inside: avoid;
      }
      .metric {
        background: transparent; border: none; padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .metric-featured {
        background: #f0f8fa !important; border: 1px solid var(--accent); padding: 15px;
      }

      #limitAmountCell, #netRetCell { color: var(--success-text) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      details.calc-process { border: 1px solid #000; page-break-inside: avoid; }
      
      .detail-table th { background: #eee !important; color: #000; border: 1px solid #000; }
      .detail-table td { border: 1px solid #000; color: #000; }

      .note-card {
        display: block !important; border: 1px solid #eee;
        background: #f9f9f9 !important; page-break-inside: avoid;
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
      }
      .note-highlight {
        border: 1px solid #f5e2a0 !important; background-color: #fffbe8 !important;
        color: #6a4c0a !important; padding: 5px 10px; font-size: 9pt;
      }

      .grid, .grid-2 { display: block !important; }
      .grid > div, .grid-2 > div { margin-bottom: 5px; page-break-inside: avoid; }
    }
  </style>
</head>
<body>

<!-- 印刷用 固定ヘッダー -->
<div class="print-header-fixed">
  <div class="print-logo-section">
    <img src="ロゴ.png" alt="Logo" class="print-logo" onerror="this.style.display='none';">
    <span class="print-company-name">税理士法人松本会計事務所</span>
  </div>
  <div class="print-report-title">退職金試算シミュレーションレポート</div>
</div>

<!-- 印刷用 固定フッター -->
<div class="print-footer-fixed">
  <img src="footer.png" alt="Copyright (c) Matsumoto Accounting Office." class="print-footer-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
  <span style="display:none; font-size:9pt; color:#888;">© 税理士法人松本会計事務所</span>
</div>

<div class="app">
  
  <!-- 画面表示用ヘッダー -->
  <header class="app-header">
    <div class="header-bar">
      <a href="https://takatrp.github.io/tool-portal/" class="brand">
        <img src="ロゴ.png" alt="税理士法人松本会計事務所" class="brand-logo" onerror="this.style.display='none';">
        <div class="brand-text">
          <h1 class="brand-title">退職金試算ツール</h1>
          <p class="brand-subtitle">役員退職金の適正額目安 ／ 退職手当の手取り概算</p>
        </div>
      </a>
    </div>
  </header>

  <main class="layout">

    <section class="card input-section">
      <div class="card-header">
        <h2 class="card-title">基本情報入力</h2>
      </div>
      <div class="card-body">
        <div class="field">
          <label>対象者区分</label>
          <div class="radio-row">
            <label class="radio-chip">
              <input type="radio" name="userType" value="executive" checked>
              <span>役員</span>
            </label>
            <label class="radio-chip">
              <input type="radio" name="userType" value="employee">
              <span>一般従業員</span>
            </label>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:20px;">
          <!-- 左カラム -->
          <div id="leftCol">
            <div class="field" id="lastSalaryField">
              <label for="lastSalary">最終月額報酬（額面）</label>
              <input id="lastSalary" type="text" inputmode="numeric" placeholder="例）1,000,000" class="yen-input" />
              <div class="suffix">円／月</div>
            </div>

            <div class="field" id="totalYearsField">
              <label for="totalYears" id="totalYearsLabel">勤続期間（従業員期間含む）</label>
              <input id="totalYears" type="number" min="0" step="1" placeholder="例）25" />
              <div class="suffix">年（退職所得控除の計算に使用）</div>
            </div>

            <div class="field" id="officerYearsField">
              <label for="officerYears">うち役員在任期間</label>
              <input id="officerYears" type="number" min="0" step="1" placeholder="例）10" />
              <div class="suffix">年（適正額・特定役員の判定に使用）</div>
            </div>

            <div class="field" id="reasonField">
              <label for="reason">退職理由</label>
              <select id="reason">
                <option value="normal" selected>通常の退職（定年・自己都合・会社都合など）</option>
                <option value="disabled">障害退職（障害者となったことに直接起因する退職）</option>
              </select>
              <div class="suffix">障害退職の場合は退職所得控除に100万円加算します。</div>
            </div>
          </div>

          <!-- 右カラム -->
          <div id="rightCol">
            <div class="field" id="multiplierField">
              <label for="roleSelect">功績倍率（係数）</label>
              <select id="roleSelect" style="margin-bottom:8px;">
                <option value="custom">― 自由入力 ―</option>
                <option value="3.0" selected>代表取締役・CEO（3.0）</option>
                <option value="2.5">専務・常務取締役（2.5）</option>
                <option value="2.0">取締役（2.0）</option>
                <option value="1.5">非常勤役員（1.5）</option>
              </select>
              <div style="display:flex; align-items:center; gap:8px;">
                <label for="factor" style="font-size:0.8rem; margin:0; white-space:nowrap;">倍率手入力:</label>
                <input id="factor" type="number" min="0" step="0.1" placeholder="例）3.0" value="3.0" style="padding:8px;" />
              </div>
            </div>

            <div class="field" id="meritAdditionField">
              <label for="meritAddition">功労加算金（上乗せ・任意）</label>
              <input id="meritAddition" type="text" inputmode="numeric" placeholder="0" class="yen-input" />
              <div class="suffix">円（特別な功労がある場合など）</div>
              <div class="chips-container">
                <button type="button" class="helper-btn" data-percent="10">＋10%</button>
                <button type="button" class="helper-btn" data-percent="20">＋20%</button>
                <button type="button" class="helper-btn" data-percent="30">＋30%</button>
              </div>
            </div>

            <div class="field" id="actualAmountField">
              <label for="actualAmount" id="actualAmountLabel">支給金額（予定）</label>
              <input id="actualAmount" type="text" inputmode="numeric" placeholder="支給総額を入力" class="yen-input" />
              <div class="suffix" id="actualAmountSuffix">円（役員は未入力時、目安額で計算）</div>
            </div>

            <div class="field" id="splitField" style="margin-top:10px;">
              <label class="checkbox-chip">
                <input type="checkbox" id="enableSplit">
                <span>役員部分と従業員部分に分けて課税計算する（上級者向け）</span>
              </label>
            </div>

            <div id="splitContainer" class="hidden" style="background:#f9f9f9; padding:12px; border-radius:8px; border:1px solid #eee;">
              <div class="field" id="officerPartField">
                <label for="officerPart">役員期間に対応する退職金</label>
                <input id="officerPart" type="text" inputmode="numeric" placeholder="例）20,000,000" class="yen-input" />
                <div class="suffix">円（特定役員退職手当等の対象部分）</div>
              </div>
              <div class="field" id="employeePartField" style="margin-top:10px;">
                <label for="employeePart">従業員期間に対応する退職金</label>
                <input id="employeePart" type="text" inputmode="numeric" placeholder="例）10,000,000" class="yen-input" />
                <div class="suffix">円（一般／短期退職手当等の対象部分）</div>
              </div>
            </div>
          </div>
        </div>

        <div class="note input-note" id="executiveNote" style="margin-top:16px;">
          ※役員の目安額（適正額）は「(最終月額報酬 × 役員在任期間 × 功績倍率) ＋ 功労加算金」で算出します。
        </div>

        <div class="btn-row">
          <button class="btn-calc" id="calcBtn">
            <span class="btn-calc-icon">▶</span>
            <span>試算する</span>
          </button>
          <button class="btn-ghost" id="resetBtnTop">リセット</button>
          <button class="btn-ghost" id="copyLimitBtn" style="border-style:solid;">目安額を「支給金額」にコピー</button>
        </div>
        <div id="error" class="error"></div>
      </div>
    </section>

    <div id="resultArea" style="display:none;">

      <section class="card result-card" id="limitSection">
        <div class="card-header">
          <h2 class="card-title">目安額と支給額の比較</h2>
        </div>
        <div class="card-body">
          <table class="detail-table" id="limitTable">
            <tbody>
              <tr>
                <th>対象者区分</th>
                <td id="userTypeCell"></td>
              </tr>
              <tr>
                <th>勤続期間（全体）</th>
                <td id="totalYearsCell"></td>
              </tr>
              <tr id="officerYearsRow">
                <th>うち役員在任期間</th>
                <td id="officerYearsCell"></td>
              </tr>
              <tr id="tokuteiRow">
                <th>特定役員判定</th>
                <td id="tokuteiCell"></td>
              </tr>
              <tr>
                <th>退職金の目安額（適正額）<br><span style="font-size:0.75rem; font-weight:normal;">(倍率法 ＋ 加算金)</span></th>
                <td id="limitAmountCell" class="highlight-val" style="font-size:1.3rem;"></td>
              </tr>
              <tr>
                <th>実際の支給額</th>
                <td id="actualAmountCell"></td>
              </tr>
              <tr>
                <th>支給額 ÷ 目安額</th>
                <td id="ratioCell"></td>
              </tr>
            </tbody>
          </table>
          <div id="ratioMsg" class="warn-text" style="display:none;"></div>

          <details class="calc-process">
            <summary>計算過程・内訳を表示</summary>
            <div class="process-content" id="processLimit"></div>
          </details>
        </div>
      </section>

      <section class="card result-card">
        <div class="card-header">
          <h2 class="card-title">税金・手取り試算</h2>
        </div>
        <div class="card-body">
          <div class="note" style="margin-bottom:12px;">
            勤続期間に基づく退職所得控除を適用し、手取り額を計算します。
          </div>

          <table class="detail-table" id="retTable">
            <tbody>
              <tr>
                <th>退職所得控除額</th>
                <td id="deductionCell">- 円</td>
              </tr>
              <tr>
                <th>課税退職所得金額<br><span style="font-size:0.75rem; font-weight:normal;">（1,000円未満切捨て後）</span></th>
                <td id="taxableRetCell">- 円</td>
              </tr>
              <tr>
                <th>所得税・復興税（源泉）</th>
                <td id="retIncomeTaxCell">- 円</td>
              </tr>
              <tr>
                <th>住民税（概算）</th>
                <td id="retInhabitantTaxCell">- 円</td>
              </tr>
              <tr>
                <th style="color:var(--accent-dark); font-weight:bold;">手取り退職金額（概算）</th>
                <td id="netRetCell" class="highlight-val" style="font-size:1.3rem;">- 円</td>
              </tr>
            </tbody>
          </table>

          <details class="calc-process">
            <summary>計算過程・内訳を表示</summary>
            <div class="process-content" id="processTax"></div>
          </details>
        </div>
      </section>

    </div>

    <section class="card note-card" style="background:var(--bg); border:none; box-shadow:none; padding:0; margin-top:20px;">
      <div class="note" style="font-size:0.8rem;">
        <strong>【ご注意・免責事項】</strong>
        <ul>
          <li><strong>損金算入の制限（不相当に高額な部分）</strong><br>
          役員退職金は、法人税法上「不相当に高額な部分」は損金算入が認められません（法人税法34条2項）。一般的には「最終報酬月額 × 役員在任年数 × 功績倍率」で計算される功績倍率法が用いられますが、この計算結果であれば無条件に認められるわけではありません。</li>
          <li><strong>功績倍率の設定根拠について</strong><br>
          本ツールで初期設定されている功績倍率（代表取締役3.0、取締役2.0等）は、過去の裁判例や税務実務において一般的とされる水準を参考にした目安です。税務上の適正額は、<strong>「同業種・同規模法人の平均的な支給倍率（平均功績倍率）」</strong>を基礎とし、本人の職務内容や会社への貢献度などを総合的に勘案して判断されます。</li>
          <li><strong>功労加算金について</strong><br>
          功労加算金（30%の上乗せ等）を支給する場合、定款の規定や株主総会の決議、および具体的な功績（創業者の功労など）を客観的に説明できる資料が必要です。根拠の薄い安易な上乗せは、税務調査で否認されるリスクが高まります。</li>
          <li><strong>税制改正や法令の変更</strong><br>
          本ツールは作成時点の法令に基づき計算を行っています。今後の税制改正により、計算方法や税率が変更される可能性があります。</li>
          <li><strong>勤続5年以下の従業員の退職金（短期退職手当等）</strong><br>
          勤続年数が5年以下の従業員に支給する退職金は、原則として「短期退職手当等」として取り扱われ、退職所得控除額を控除した残額のうち300万円を超える部分については2分の1課税が適用されません。</li>
          <li><strong>障害退職の場合</strong><br>
          障害者となったことに直接基因して退職した場合の退職所得控除額（＋100万円加算）に対応していますが、障害認定の有無や時期等の判断は、必ず専門家にご確認ください。</li>
          <li><strong>最終的な判断について</strong><br>
          本ツールは概算シミュレーションです。実際の支給額決定や税務申告にあたっては、必ず<strong>松本会計スタッフ</strong>や税理士等の専門家にご相談ください。</li>
        </ul>
      </div>
    </section>

    <section class="card" id="bottomActions">
      <div class="card-body">
        <div class="action-buttons">
          <button type="button" class="btn-soft" id="copyResultBtn">結果をコピー</button>
          <button type="button" class="btn-soft" id="resetBtnBottom">リセット</button>
          <button type="button" class="btn-outline" id="printBtn">印刷 / PDF保存</button>
        </div>
      </div>
    </section>

  </main>

  <footer class="mk-mini">
    © <span id="cpy-year">2025</span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
    <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
    <span id="build-rev">Rev. r3</span>
  </footer>
</div>

<script>
(function(){
  'use strict';

  // Init Auto Year
  (function(){
    var y=new Date().getFullYear();
    var cpy=document.getElementById('cpy-year');
    if(cpy) cpy.textContent=String(y);

    // リビジョンと日付の更新
    var revEl = document.getElementById('build-rev');
    if(revEl) {
      var d = new Date();
      var yyyy = d.getFullYear();
      var mm = String(d.getMonth() + 1).padStart(2, '0');
      var dd = String(d.getDate()).padStart(2, '0');
      revEl.textContent = 'r3（' + yyyy + '-' + mm + '-' + dd + '）';
    }
  })();

  // Inputs
  const typeRadios = document.querySelectorAll('input[name="userType"]');
  const roleSelect = document.getElementById('roleSelect');
  const factorInput = document.getElementById('factor');
  const meritAdditionInput = document.getElementById('meritAddition');
  const lastSalaryInput = document.getElementById('lastSalary');
  const totalYearsInput = document.getElementById('totalYears');
  const officerYearsInput = document.getElementById('officerYears');
  const actualAmountInput = document.getElementById('actualAmount');
  const reasonSelect = document.getElementById('reason');
  const splitToggle = document.getElementById('enableSplit');
  const officerPartInput = document.getElementById('officerPart');
  const employeePartInput = document.getElementById('employeePart');
  
  // UI Elements
  const leftCol = document.getElementById('leftCol');
  const rightCol = document.getElementById('rightCol');
  const lastSalaryField = document.getElementById('lastSalaryField');
  const totalYearsField = document.getElementById('totalYearsField');
  const officerYearsField = document.getElementById('officerYearsField');
  const reasonField = document.getElementById('reasonField');
  
  const multiplierField = document.getElementById('multiplierField');
  const meritAdditionField = document.getElementById('meritAdditionField');
  const actualAmountField = document.getElementById('actualAmountField');
  const splitField = document.getElementById('splitField');
  const splitContainer = document.getElementById('splitContainer');

  const executiveNote = document.getElementById('executiveNote');
  const totalYearsLabel = document.getElementById('totalYearsLabel');
  const actualAmountLabel = document.getElementById('actualAmountLabel');
  const actualAmountSuffix = document.getElementById('actualAmountSuffix');
  const addPercentBtns = document.querySelectorAll('.helper-btn[data-percent]');

  let currentPercent = null;

  // Buttons
  const calcBtn = document.getElementById('calcBtn');
  const resetBtnTop = document.getElementById('resetBtnTop');
  const resetBtnBottom = document.getElementById('resetBtnBottom');
  const copyLimitBtn = document.getElementById('copyLimitBtn');
  const copyResultBtn = document.getElementById('copyResultBtn');
  const printBtn = document.getElementById('printBtn');

  // Output
  const errorDiv = document.getElementById('error');
  const resultArea = document.getElementById('resultArea');
  const limitSection = document.getElementById('limitSection');
  
  // Cells
  const userTypeCell = document.getElementById('userTypeCell');
  const totalYearsCell = document.getElementById('totalYearsCell');
  const officerYearsRow = document.getElementById('officerYearsRow');
  const officerYearsCell = document.getElementById('officerYearsCell');
  const tokuteiRow = document.getElementById('tokuteiRow');
  const tokuteiCell = document.getElementById('tokuteiCell');
  const limitAmountCell = document.getElementById('limitAmountCell');
  const actualAmountCell = document.getElementById('actualAmountCell');
  const ratioCell = document.getElementById('ratioCell');
  const ratioMsg = document.getElementById('ratioMsg');
  const processLimit = document.getElementById('processLimit');

  const deductionCell = document.getElementById('deductionCell');
  const taxableRetCell = document.getElementById('taxableRetCell');
  const retIncomeTaxCell = document.getElementById('retIncomeTaxCell');
  const retInhabitantTaxCell = document.getElementById('retInhabitantTaxCell');
  const netRetCell = document.getElementById('netRetCell');
  const processTax = document.getElementById('processTax');

  // --- Helper Functions ---
  const yenInputs = document.querySelectorAll('.yen-input');
  yenInputs.forEach(input => {
    let isComposing = false;
    input.addEventListener('compositionstart', () => { isComposing = true; });
    input.addEventListener('compositionend', (e) => { isComposing = false; formatInputValue(e.target); });
    input.addEventListener('input', (e) => { if (!isComposing) formatInputValue(e.target); });
    input.addEventListener('focus', function() { this.select(); });
  });

  function formatInputValue(el) {
    const val = el.value;
    if (!val) return;
    const normalized = val.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    const raw = normalized.replace(/[^0-9]/g, '');
    if (raw) {
      const formatted = Number(raw).toLocaleString('ja-JP');
      if (el.value !== formatted) el.value = formatted;
    } else {
      el.value = '';
    }
  }

  function parseCommaInt(val) {
    if (!val) return 0;
    return parseInt(String(val).replace(/,/g, ''), 10) || 0;
  }

  function formatComma(num) {
    if (!isFinite(num)) return '';
    return num.toLocaleString('ja-JP');
  }

  function fNum(num){
    if(!isFinite(num)) return 0;
    return num.toLocaleString('ja-JP');
  }

  function formatYen(value){
    if (!isFinite(value)) return '-';
    return value.toLocaleString('ja-JP', { maximumFractionDigits: 0 }) + ' 円';
  }

  function formatYears(value){
    if (!isFinite(value)) return '-';
    return value.toFixed(2).replace(/\.00$/,'') + ' 年';
  }

  function createProcessHTML(lines) {
    return lines.map(line => `<div class="process-formula">${line}</div>`).join('');
  }

  function calcRetirementDeduction(yearsRaw){
    if (!isFinite(yearsRaw) || yearsRaw <= 0) return 0;
    const years = Math.ceil(yearsRaw);
    if (years <= 20){
      const base = 400000 * years;
      return base < 800000 ? 800000 : base;
    } else {
      return 8000000 + 700000 * (years - 20);
    }
  }

  function calcProgressiveTax(taxable){
    if (!isFinite(taxable) || taxable <= 0) return 0;
    let rate, deduction;
    if (taxable <= 1950000){ rate = 0.05; deduction = 0; }
    else if (taxable <= 3300000){ rate = 0.10; deduction = 97500; }
    else if (taxable <= 6950000){ rate = 0.20; deduction = 427500; }
    else if (taxable <= 9000000){ rate = 0.23; deduction = 636000; }
    else if (taxable <= 18000000){ rate = 0.33; deduction = 1536000; }
    else if (taxable <= 40000000){ rate = 0.40; deduction = 2796000; }
    else { rate = 0.45; deduction = 4796000; }
    
    let tax = (taxable * rate - deduction) * 1.021;
    if (tax < 0) tax = 0;
    return Math.floor(tax); // 1円未満切捨て
  }

  function calcInhabitantTaxRetirement(taxable){
    if (!isFinite(taxable) || taxable <= 0) return 0;
    const raw = taxable * 0.10; // 市民税6％＋県民税4％
    return Math.floor(raw / 100) * 100; // 100円未満切捨て
  }

  // UI切り替え
  function updateUI(){
    const isExecutive = document.querySelector('input[name="userType"]:checked').value === 'executive';
    
    // エレメントのDOM上の位置をリセットするのではなく、必要なものを表示・非表示にする
    
    if (isExecutive) {
      lastSalaryField.classList.remove('hidden');
      officerYearsField.classList.remove('hidden');
      multiplierField.classList.remove('hidden');
      meritAdditionField.classList.remove('hidden');
      splitField.classList.remove('hidden');
      splitContainer.classList.toggle('hidden', !splitToggle.checked);
      
      // 役員の場合は支給金額（予定）入力欄を隠す（削除扱い）
      actualAmountField.classList.add('hidden');
      copyLimitBtn.style.display = 'none';
      
      executiveNote.style.display = 'block';

      totalYearsLabel.textContent = '勤続期間（従業員期間含む）';
      
      // レイアウト調整（リセットして再配置）
      // 左カラム
      leftCol.appendChild(lastSalaryField);
      leftCol.appendChild(totalYearsField);
      leftCol.appendChild(officerYearsField);
      leftCol.appendChild(reasonField);
      
      // 右カラム
      rightCol.appendChild(multiplierField);
      rightCol.appendChild(meritAdditionField);
      // actualAmountFieldは隠すがDOMには残す
      rightCol.appendChild(actualAmountField);
      rightCol.appendChild(splitField);
      rightCol.appendChild(splitContainer);

    } else {
      lastSalaryField.classList.add('hidden');
      officerYearsField.classList.add('hidden');
      multiplierField.classList.add('hidden');
      meritAdditionField.classList.add('hidden');
      splitField.classList.add('hidden');
      splitContainer.classList.add('hidden');
      
      // 従業員の場合は支給金額入力を表示
      actualAmountField.classList.remove('hidden');
      copyLimitBtn.style.display = 'none';
      executiveNote.style.display = 'none';

      totalYearsLabel.textContent = '勤続期間';
      actualAmountLabel.textContent = '支給金額（直接入力）';
      actualAmountSuffix.textContent = '円';

      splitToggle.checked = false;
      officerPartInput.value = '';
      employeePartInput.value = '';

      // 一般従業員：支給金額 → 勤続期間 の順に左カラムへ配置
      leftCol.appendChild(actualAmountField);
      leftCol.appendChild(totalYearsField);
      leftCol.appendChild(reasonField);
    }
    resultArea.style.display = 'none';
    errorDiv.textContent = '';
  }

  // Auto-calc Merit Addition
  function updateMeritAddition() {
    if (currentPercent === null) return;
    const lastSalary = parseCommaInt(lastSalaryInput.value);
    const officerYears = Number(officerYearsInput.value);
    const factor = Number(factorInput.value);
    if (lastSalary > 0 && officerYears > 0 && factor > 0) {
      const base = lastSalary * officerYears * factor;
      const addition = Math.floor(base * (currentPercent / 100));
      meritAdditionInput.value = formatComma(addition);
    }
  }

  // Event Listeners
  typeRadios.forEach(radio => radio.addEventListener('change', updateUI));
  
  roleSelect.addEventListener('change', () => {
    const v = roleSelect.value;
    if (v === 'custom') return; 
    factorInput.value = v;
    updateMeritAddition(); 
  });

  factorInput.addEventListener('input', () => {
    roleSelect.value = 'custom';
    updateMeritAddition(); 
  });

  lastSalaryInput.addEventListener('input', updateMeritAddition);
  officerYearsInput.addEventListener('input', updateMeritAddition);
  meritAdditionInput.addEventListener('input', (e) => {
      if (e.isTrusted) {
          currentPercent = null;
          addPercentBtns.forEach(b => b.classList.remove('active'));
      }
  });

  addPercentBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const percent = Number(e.target.dataset.percent);
      if (currentPercent === percent) {
          currentPercent = null;
          addPercentBtns.forEach(b => b.classList.remove('active'));
      } else {
          currentPercent = percent;
          addPercentBtns.forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          const lastSalary = parseCommaInt(lastSalaryInput.value);
          const officerYears = Number(officerYearsInput.value);
          const factor = Number(factorInput.value);
          if (lastSalary > 0 && officerYears > 0 && factor > 0) {
              updateMeritAddition();
          } else {
              alert('先に報酬・年数・倍率を入力してください。');
              currentPercent = null;
              e.target.classList.remove('active');
          }
      }
    });
  });

  splitToggle.addEventListener('change', () => {
    const isExecutive = document.querySelector('input[name="userType"]:checked').value === 'executive';
    if (!isExecutive) {
      splitToggle.checked = false;
      return;
    }
    splitContainer.classList.toggle('hidden', !splitToggle.checked);
  });

  // Main Calculation
  calcBtn.addEventListener('click', () => {
    errorDiv.textContent = '';
    ratioMsg.style.display = 'none';
    resultArea.style.display = 'none';

    const userTypeValue = document.querySelector('input[name="userType"]:checked').value;
    const isExecutive = (userTypeValue === 'executive');
    const isDisabled = (reasonSelect.value === 'disabled');
    const splitEnabled = isExecutive && splitToggle.checked;

    const lastSalary = parseCommaInt(lastSalaryInput.value);
    const totalYearsRaw = Number(totalYearsInput.value || 0);
    let officerYearsRaw = Number(officerYearsInput.value || 0);
    const factor = Number(factorInput.value);
    const meritAddition = parseCommaInt(meritAdditionInput.value);
    const actualInputRaw = parseCommaInt(actualAmountInput.value); 

    if (!isFinite(totalYearsRaw) || totalYearsRaw <= 0){
      errorDiv.textContent = '勤続期間を入力してください';
      return;
    }
    
    if (isExecutive) {
      if (!lastSalary || lastSalary <= 0){ errorDiv.textContent = '最終月額報酬を入力してください'; return; }
      if (!isFinite(officerYearsRaw) || officerYearsRaw <= 0){ errorDiv.textContent = '役員在任期間を入力してください'; return; }
      if (officerYearsRaw > totalYearsRaw){ errorDiv.textContent = '役員在任期間が勤続期間を超えています'; return; }
      if (factor === null || factor === undefined || factor < 0){ errorDiv.textContent = '功績倍率を正しく入力してください'; return; }

      const baseLimit = lastSalary * officerYearsRaw * factor;
      const calculatedLimit = baseLimit + meritAddition;

      if (splitEnabled) {
        const officerPartVal = parseCommaInt(officerPartInput.value);
        const employeePartVal = parseCommaInt(employeePartInput.value);
        if (officerPartVal < 0 || employeePartVal < 0) {
          errorDiv.textContent = '役員部分または従業員部分を正しく入力してください'; return;
        }
        const sumParts = officerPartVal + employeePartVal;
        
        // 役員モードでSplitを使う場合、自動計算された目安額(支給額)と一致しているかチェック
        // ※少額の誤差は許容しない厳密一致とするか、入力値を正とするか。
        // ここでは「支給金額欄削除」の指示に従い、LimitAmountが正となるため、内訳合計が一致しない場合はエラーとする
        if (Math.abs(sumParts - calculatedLimit) > 0) {
           errorDiv.textContent = `役員部分と従業員部分の合計(${formatComma(sumParts)}円)が、算出された退職金適正額(${formatComma(calculatedLimit)}円)と一致しません。`;
           return;
        }
      }
    } else {
      if (!actualInputRaw || actualInputRaw <= 0) {
        errorDiv.textContent = '支給金額を入力してください'; return;
      }
    }

    const totalYearsCeil = Math.ceil(totalYearsRaw);
    const officerYearsCeil = Math.ceil(officerYearsRaw || 0);
    let limitAmount = 0;
    let actualAmount = 0;

    if (isExecutive) {
      const baseLimit = lastSalary * officerYearsRaw * factor;
      limitAmount = baseLimit + meritAddition;
      
      // 役員の場合、実際の支給額は計算された目安額とみなす
      actualAmount = limitAmount;
      
      // Split有効時の処理
      // チェック済みなので、計算にはlimitAmount(==actualAmount)を使用し、内訳は入力値を使う
    } else {
      limitAmount = 0;
      actualAmount = actualInputRaw;
    }

    // Deduction
    const baseDeduction = calcRetirementDeduction(totalYearsRaw);
    let deduction = baseDeduction;
    if (isDisabled) deduction += 1000000;

    // Taxable
    let taxableRetRaw = 0;
    let taxCalcNote = '';
    const isTokuteiBasic = isExecutive && (officerYearsCeil > 0 && officerYearsCeil <= 5);
    const isShortEmployeeWhole = !isExecutive && (totalYearsCeil > 0 && totalYearsCeil <= 5);

    if (actualAmount <= deduction) {
      taxableRetRaw = 0;
      taxCalcNote = '（控除額が支給額以上のため、課税退職所得なし）';
    } else {
      if (isExecutive && splitEnabled && isTokuteiBasic) {
        const officerPartVal = parseCommaInt(officerPartInput.value);
        const employeePartVal = parseCommaInt(employeePartInput.value);
        let tokuteiYears = Math.min(officerYearsCeil, totalYearsCeil);
        let tokuteiDeduction = Math.min(400000 * tokuteiYears, deduction);
        let generalDeduction = Math.max(0, deduction - tokuteiDeduction);
        
        let baseTokutei = Math.max(0, officerPartVal - tokuteiDeduction);
        const taxableTokutei = baseTokutei;

        let baseGeneral = Math.max(0, employeePartVal - generalDeduction);
        const generalYearsCeil = Math.max(0, totalYearsCeil - officerYearsCeil);
        let taxableGeneral = 0;
        const isShortEmployeePortion = generalYearsCeil > 0 && generalYearsCeil <= 5;

        if (baseGeneral > 0) {
          if (isShortEmployeePortion) {
            if (baseGeneral <= 3000000) {
              taxableGeneral = Math.floor(baseGeneral / 2);
              taxCalcNote = '（役員部分：特定、従業員部分：短期300万円以下1/2）';
            } else {
              taxableGeneral = 1500000 + (baseGeneral - 3000000);
              taxCalcNote = '（役員部分：特定、従業員部分：短期300万円超1/2なし）';
            }
          } else {
            taxableGeneral = Math.floor(baseGeneral / 2);
            taxCalcNote = '（役員部分：特定、従業員部分：一般1/2）';
          }
        } else {
          taxCalcNote = '（役員部分：特定のみ）';
        }
        taxableRetRaw = taxableTokutei + taxableGeneral;

      } else {
        const base = actualAmount - deduction;
        if (base <= 0) {
          taxableRetRaw = 0;
          taxCalcNote = '（控除額が支給額以上のため、課税なし）';
        } else {
          if (isTokuteiBasic) {
            taxableRetRaw = base;
            taxCalcNote = '（特定役員：全額1/2なし）';
          } else if (isShortEmployeeWhole) {
            if (base <= 3000000) {
              taxableRetRaw = Math.floor(base / 2);
              taxCalcNote = '（短期：300万円以下1/2）';
            } else {
              taxableRetRaw = 1500000 + (base - 3000000);
              taxCalcNote = '（短期：300万円超1/2なし）';
            }
          } else {
            taxableRetRaw = Math.floor(base / 2);
            taxCalcNote = '× 1/2（一般）';
          }
        }
      }
    }

    let taxableForTable = 0;
    if (taxableRetRaw > 0) taxableForTable = Math.floor(taxableRetRaw / 1000) * 1000;

    const retIncomeTax = calcProgressiveTax(taxableForTable);
    const retInhabitantTax = calcInhabitantTaxRetirement(taxableForTable);
    const netRet = actualAmount - retIncomeTax - retInhabitantTax;

    // Display
    if (isExecutive) {
      limitSection.style.display = 'block';
      userTypeCell.textContent = '役員';
      totalYearsCell.textContent = formatYears(totalYearsRaw) + ' (控除計算: ' + totalYearsCeil + '年)';
      officerYearsRow.style.display = 'table-row';
      officerYearsCell.textContent = formatYears(officerYearsRaw) + ' (判定: ' + officerYearsCeil + '年)';
      
      tokuteiRow.style.display = 'table-row';
      const generalYearsCeil = Math.max(totalYearsCeil - officerYearsCeil, 0);
      if (!isTokuteiBasic) {
        tokuteiCell.innerHTML = '一般退職<span class="pill pill-ok">6年以上</span>';
      } else if (splitEnabled && generalYearsCeil > 0) {
        tokuteiCell.innerHTML = '特定役員＋一般退職<span class="pill pill-danger">役員5年以下</span>';
      } else {
        tokuteiCell.innerHTML = '特定役員<span class="pill pill-danger">5年以下</span>';
      }

      limitAmountCell.textContent = formatYen(limitAmount);
      actualAmountCell.textContent = formatYen(actualAmount);
      // 役員の場合は計算値＝支給額なので常に100%
      ratioCell.textContent = '100%';
      ratioMsg.style.display = 'none';

      const baseVal = lastSalary * officerYearsRaw * factor;
      let limitProcess = [
        `ベース部分 = 月額 ${fNum(lastSalary)} × 年数 ${officerYearsRaw} × 倍率 ${factor} = ${fNum(baseVal)}`,
        `功労加算金 = ${fNum(meritAddition)}`,
        `目安額合計 = ${fNum(baseVal)} + ${fNum(meritAddition)} = ${fNum(limitAmount)}円`
      ];
      processLimit.innerHTML = createProcessHTML(limitProcess);

    } else {
      limitSection.style.display = 'none';
    }

    deductionCell.textContent = formatYen(deduction);
    taxableRetCell.textContent = formatYen(taxableForTable);
    retIncomeTaxCell.textContent = formatYen(retIncomeTax);
    retInhabitantTaxCell.textContent = formatYen(retInhabitantTax);
    netRetCell.textContent = formatYen(netRet);

    let dedCalcStrBase = (totalYearsCeil <= 20) ? `40万円 × ${totalYearsCeil}年` : `800万円 + 70万円 × (${totalYearsCeil}年 - 20年)`;
    if (isDisabled) dedCalcStrBase += ' ＋ 加算100万円';
    
    let taxProcessLines = [
      `退職所得控除 = ${dedCalcStrBase} = ${fNum(deduction)}`,
      `課税退職所得 = ${taxableForTable <= 0 ? '0円' : `${fNum(taxableForTable)}円 ${taxCalcNote}`}`,
      `源泉所得税 = 速算表算出 (${fNum(retIncomeTax)}円)`,
      `住民税 = ${fNum(taxableForTable)} × 10% = ${fNum(retInhabitantTax)}円`
    ];
    processTax.innerHTML = createProcessHTML(taxProcessLines);

    resultArea.style.display = 'block';
    setTimeout(() => resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
  });

  // Utils
  function resetAll() {
    document.querySelector('input[value="executive"]').checked = true;
    reasonSelect.value = 'normal';
    splitToggle.checked = false;
    officerPartInput.value = '';
    employeePartInput.value = '';
    splitContainer.classList.add('hidden');
    updateUI();
    
    lastSalaryInput.value = '';
    totalYearsInput.value = '';
    officerYearsInput.value = '';
    factorInput.value = '3.0';
    roleSelect.value = '3.0';
    meritAdditionInput.value = '';
    currentPercent = null;
    addPercentBtns.forEach(b => b.classList.remove('active'));
    actualAmountInput.value = '';
    
    errorDiv.textContent = '';
    resultArea.style.display = 'none';
    document.querySelectorAll('details.calc-process').forEach(d => d.removeAttribute('open'));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  resetBtnTop.addEventListener('click', resetAll);
  resetBtnBottom.addEventListener('click', resetAll);

  // copyLimitBtnは役員モードでは非表示になるため実質未使用だが、コードは残しておく
  copyLimitBtn.addEventListener('click', () => {
    const lastSalary = parseCommaInt(lastSalaryInput.value);
    const officerYears = Number(officerYearsInput.value);
    const factor = Number(factorInput.value);
    const addition = parseCommaInt(meritAdditionInput.value);
    if (lastSalary > 0 && officerYears > 0 && factor >= 0){
      const limitAmount = (lastSalary * officerYears * factor) + addition;
      actualAmountInput.value = formatComma(Math.floor(limitAmount));
      errorDiv.textContent = '';
    } else {
      errorDiv.textContent = '報酬、役員在任期間、倍率を入力してください';
    }
  });

  copyResultBtn.addEventListener('click', () => {
    if(resultArea.style.display === 'none') { alert('まずは試算を行ってください'); return; }
    const isExec = document.querySelector('input[name="userType"]:checked').value === 'executive';
    let text = ["【退職金試算結果】", `対象区分: ${isExec ? '役員' : '一般従業員'}`];
    if (isExec) text.push(`目安額: ${limitAmountCell.textContent}`);
    text.push(`支給金額: ${actualAmountCell.textContent}`);
    text.push(`手取り額: ${netRetCell.textContent}`);
    text.push("※本結果は概算です。");
    navigator.clipboard.writeText(text.join('\n')).then(() => alert('コピーしました'));
  });

  printBtn.addEventListener('click', () => window.print());

  updateUI();
})();
</script>
</body>
</html>
